# Test code for the ACI modules
# Copyright: (c) 2017, Jacob McGill (@jmcgill298)

# GNU General Public License v3.0+ (see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt)

- name: Test that we have an ACI APIC host, ACI username and ACI password
  ansible.builtin.fail:
    msg: 'Please define the following variables: aci_hostname, aci_username and aci_password.'
  when: aci_hostname is not defined or aci_username is not defined or aci_password is not defined

# SET VARS
- name: Set vars
  ansible.builtin.set_fact:
    aci_info: &aci_info
      host: '{{ aci_hostname }}'
      username: '{{ aci_username }}'
      password: '{{ aci_password }}'
      validate_certs: '{{ aci_validate_certs | default(false) }}'
      use_ssl: '{{ aci_use_ssl | default(true) }}'
      use_proxy: '{{ aci_use_proxy | default(true) }}'
      output_level: '{{ aci_output_level | default("info") }}'

- name: Query system information
  cisco.aci.aci_system:
    <<: *aci_info
    id: 1
    state: query
  register: version

- name: Verify Cloud and Non-Cloud Sites in use.
  ansible.builtin.include_tasks: ../../../../../../integration/targets/aci_cloud_provider/tasks/main.yml

- name: Execute tasks only for ACI v5+ and non-cloud sites
  when:
  - version.current.0.topSystem.attributes.version is version('5', '>=')
  - query_cloud.current == []  # This condition will execute only non-cloud sites
  block:  # block specifies execution of tasks within, based on conditions
    - name: create contract - check mode works
      cisco.aci.aci_oob_contract: &aci_oob_contract_present
        <<: *aci_info
        contract: anstest
        description: Ansible Test
      check_mode: true
      register: present_check_mode

    - name: create contract - creation works
      cisco.aci.aci_oob_contract:
        <<: *aci_oob_contract_present
      register: contract_present

    - name: create contract - idempotency works
      cisco.aci.aci_oob_contract:
        <<: *aci_oob_contract_present
      register: present_idempotent

    - name: update contract - update works
      cisco.aci.aci_oob_contract:
        <<: *aci_oob_contract_present
        scope: application-profile
      register: present_update

    - name: create contract - used for query
      cisco.aci.aci_oob_contract:
        <<: *aci_oob_contract_present
        contract: anstest2

    - name: missing param - failure message works
      cisco.aci.aci_oob_contract:
        <<: *aci_info
      ignore_errors: true
      register: present_missing_param

    - name: present assertions
      ansible.builtin.assert:
        that:
          - present_check_mode is changed
          - present_check_mode.previous == []
          - present_check_mode.sent.vzOOBBrCP.attributes.name == 'anstest'
          - present_check_mode.sent.vzOOBBrCP.attributes.descr == 'Ansible Test'
          - contract_present is changed
          - contract_present.current.0.vzOOBBrCP.attributes.annotation == 'orchestrator:ansible'
          - contract_present.sent == present_check_mode.sent
          - present_idempotent is not changed
          - present_update is changed
          - present_update.sent != present_update.proposed
          - present_update.sent.vzOOBBrCP.attributes.scope == "application-profile"
          - present_missing_param is failed
          - 'present_missing_param.msg == "state is present but all of the following are missing: contract"'

    - name: query contract
      cisco.aci.aci_oob_contract: &aci_oob_contract_query
        <<: *aci_oob_contract_present
        state: query
      register: query_contract

    - name: query all
      cisco.aci.aci_oob_contract:
        <<: *aci_oob_contract_query
        contract: "{{ fakevar | default(omit) }}"
      register: query_tenant

    - name: query assertions
      ansible.builtin.assert:
        that:
          - query_contract is not changed
          - query_contract.current | length == 1
          - '"tn-mgmt/oobbrc-anstest.json" in query_contract.url'
          - query_tenant is not changed
          - query_tenant.current | length == 1
          - query_tenant.current.0.fvTenant.children | length > 1
          - '"rsp-subtree-class=vzOOBBrCP" in query_tenant.filter_string'
          - '"tn-mgmt.json" in query_tenant.url'


    - name: delete contract - check mode works
      cisco.aci.aci_oob_contract: &aci_oob_contract_absent
        <<: *aci_oob_contract_present
        state: absent
      check_mode: true
      register: absent_check_mode

    - name: delete contract - deletion works
      cisco.aci.aci_oob_contract:
        <<: *aci_oob_contract_absent
      register: contract_absent

    - name: delete contract - idempotency works
      cisco.aci.aci_oob_contract:
        <<: *aci_oob_contract_absent
      register: absent_idempotent

    - name: delete contract - cleanup second contract
      cisco.aci.aci_oob_contract:
        <<: *aci_oob_contract_absent
        contract: anstest2

    - name: missing param - fail message works
      cisco.aci.aci_oob_contract:
        <<: *aci_oob_contract_absent
        contract: "{{ fakevar | default(omit) }}"
      ignore_errors: true
      register: absent_missing_param

    - name: absent assertions
      ansible.builtin.assert:
        that:
          - absent_check_mode is changed
          - absent_check_mode.previous != []
          - contract_absent is changed
          - contract_absent.previous == absent_check_mode.previous
          - absent_idempotent is not changed
          - absent_idempotent.previous == []
          - absent_missing_param is failed
          - 'absent_missing_param.msg == "state is absent but all of the following are missing: contract"'
