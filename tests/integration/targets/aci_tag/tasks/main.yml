# Test code for the ACI modules
# Copyright: (c) 2017, Jacob McGill (@jmcgill298)
# Copyright: (c) 2020, Shreyas Srish (@shrsr)

# GNU General Public License v3.0+ (see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt)
- name: Test that we have an ACI APIC host, ACI username and ACI password
  fail:
    msg: 'Please define the following variables: aci_hostname, aci_username and aci_password.'
  when: aci_hostname is not defined or aci_username is not defined or aci_password is not defined

- name: Set vars
  set_fact:
    aci_info: &aci_info
      host: "{{ aci_hostname }}"
      username: "{{ aci_username }}"
      password: "{{ aci_password }}"
      validate_certs: '{{ aci_validate_certs | default(false) }}'
      use_ssl: '{{ aci_use_ssl | default(true) }}'
      use_proxy: '{{ aci_use_proxy | default(true) }}'
      output_level: debug
    test_vars_annotation: &test_vars_annotation
      tag_key: foo
      tag_value: bar
      tag_type: annotation
    test_vars_instance: &test_vars_instance
      tag_key: foo
      tag_type: instance
    test_vars_tag: &test_vars_tag
      tag_key: foo
      tag_value: bar
      tag_type: tag
    test_vars_tenant: &test_vars_tenant
      tenant: tag_test

- name: Add tenant
  cisco.aci.aci_tenant:
    <<: *aci_info
    <<: *test_vars_tenant
    tenant: tag_test
    state: present
  delegate_to: localhost
  register: query_result

- name: Get DN
  set_fact:
    dn: "{{ query_result.current[0].fvTenant.attributes.dn }}"

- name:  Annotation Query tag
  cisco.aci.aci_tag:
    <<: *aci_info
    tag_type: annotation
    state: query
  delegate_to: localhost

- name: Annotation Create tag
  cisco.aci.aci_tag:
    <<: *aci_info
    <<: *test_vars_annotation
    dn: "{{ dn }}"
    state: present
  delegate_to: localhost
  register: annotation_create_result

- name: Annotation tag created
  assert:
    that:
    - annotation_create_result.current.0.tagAnnotation.attributes.key == "foo"
    - annotation_create_result.current.0.tagAnnotation.attributes.value == "bar"

- name: Annotation Query tag
  cisco.aci.aci_tag:
    <<: *aci_info
    <<: *test_vars_annotation
    dn: "{{ dn }}"
    state: query
  delegate_to: localhost
  register: annotation_query_result

- name: Annotation tag query verification
  assert:
    that:
    - annotation_create_result.current.0.tagAnnotation.attributes.key == "foo"
    - annotation_create_result.current.0.tagAnnotation.attributes.value == "bar"

- name: Annotation Delete tag
  cisco.aci.aci_tag:
    <<: *aci_info
    <<: *test_vars_annotation
    dn: "{{ dn }}"
    state: absent
  delegate_to: localhost
  register: annotation_delete_result

- name: Annotation tag deleted
  assert:
    that:
    - annotation_delete_result.current.0.tagAnnotation is not defined

- name: Annotation Query tag
  cisco.aci.aci_tag:
    <<: *aci_info
    <<: *test_vars_annotation
    dn: "{{ dn }}"
    state: query
  delegate_to: localhost

- name: Instance Query tag
  cisco.aci.aci_tag:
    <<: *aci_info
    tag_type: instance
    state: query
  delegate_to: localhost

- name: Instance Create tag
  cisco.aci.aci_tag:
    <<: *aci_info
    <<: *test_vars_instance
    dn: "{{ dn }}"
    state: present
  delegate_to: localhost
  register: instance_create_result

- name: Instance tag created
  assert:
    that:
    - instance_create_result.current.0.tagInst.attributes.name == "foo"

- name: Instance Query tag
  cisco.aci.aci_tag:
    <<: *aci_info
    <<: *test_vars_instance
    dn: "{{ dn }}"
    state: query
  delegate_to: localhost
  register: instance_query_result

- name: Instance tag query verification
  assert:
    that:
    - instance_query_result.current.0.tagInst.attributes.name == "foo"

- name: Instance Delete tag
  cisco.aci.aci_tag:
    <<: *aci_info
    <<: *test_vars_instance
    dn: "{{ dn }}"
    state: absent
  delegate_to: localhost
  register: instance_delete_result

- name: Instance tag deleted
  assert:
    that:
    - instance_delete_result.current.0.tagInst is not defined

- name: Instance Query tag
  cisco.aci.aci_tag:
    <<: *aci_info
    <<: *test_vars_instance
    dn: "{{ dn }}"
    state: query
  delegate_to: localhost

- name: Tag Query tag
  cisco.aci.aci_tag:
    <<: *aci_info
    tag_type: tag
    state: query
  delegate_to: localhost

- name: Tag Create tag
  cisco.aci.aci_tag:
    <<: *aci_info
    <<: *test_vars_tag
    dn: "{{ dn }}"
    state: present
  delegate_to: localhost
  register: tag_create_result

- name: Tag tag created
  assert:
    that:
    - tag_create_result.current.0.tagTag.attributes.key == "foo"
    - tag_create_result.current.0.tagTag.attributes.value == "bar"

- name: Tag Query tag
  cisco.aci.aci_tag:
    <<: *aci_info
    <<: *test_vars_tag
    dn: "{{ dn }}"
    state: query
  delegate_to: localhost
  register: tag_query_result

- name: Tag tag query verification
  assert:
    that:
    - tag_query_result.current.0.tagTag.attributes.key == "foo"
    - tag_query_result.current.0.tagTag.attributes.value == "bar"

- name: Tag Delete tag
  cisco.aci.aci_tag:
    <<: *aci_info
    <<: *test_vars_tag
    dn: "{{ dn }}"
    state: absent
  delegate_to: localhost
  register: tag_delete_result

- name: Tag tag deleted
  assert:
    that:
    - tag_delete_result.current.0.tagTag is not defined

- name: Tag Query tag
  cisco.aci.aci_tag:
    <<: *aci_info
    <<: *test_vars_tag
    dn: "{{ dn }}"
    state: query
  delegate_to: localhost

- name: Remove tenant
  cisco.aci.aci_tenant:
    <<: *aci_info
    <<: *test_vars_tenant
    tenant: tag_test
    state: absent
  delegate_to: localhost
